#!/bin/sh

# We cannot use go test -coverprofile=cover.out ./... because
# the tool requires that it be used only on one package when
# capturing the coverage

# This is why we need this little script here.
packages="./src/cache ./src/apps/pblcached"

for pkg in $packages ; do
    echo "-- Testing $pkg --"

    # Collect coverage
    go test -covermode=count -coverprofile=cover.out $pkg || exit 1

    # Show in the command line
    go tool cover -func=cover.out

    # Send to coveralls.io
    $HOME/gopath/bin/goveralls \
        -coverprofile=coverprofile \
        -service=travis-ci \
        -repotoken $COVERALLS_TOKEN

    # Cleanup
    rm -f cover.out
done
